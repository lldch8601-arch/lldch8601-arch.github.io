<script>
        const URL_BESTSELLERS = "https://img.hohopick.top/march_bestsellers.json";
        const URL_PRO = "https://img.hohopick.top/mar_pro.json";
        const PAGE_SIZE = 12;

        let allBestsellers = [];
        let allProProducts = [];
        let filteredBestsellers = [];
        let currentPage = 1;
        
        let currentFilter = ""; 
        let currentCoreTerm = ""; 
        
        // 【关键变量】记录滚动位置和页码
        let lastScrollPosition = 0;
        let savedPageCount = 1;

        let isFirstLoad = true;
        let isLoading = false;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            initSidebar();
            initPopup();
        });

        async function loadAllData() {
            if(isFirstLoad) document.getElementById('initialLoading').style.display = 'flex';
            try {
                const res1 = await fetch(URL_BESTSELLERS, { cache: "default" });
                if (!res1.ok) throw new Error("热销品数据加载失败");
                
                const json1 = await res1.json();
                allBestsellers = Array.isArray(json1) ? json1 : (json1["march_bestsellers"] || []);
                filteredBestsellers = [...allBestsellers];
                
                renderBestsellers(1);
                document.getElementById('initialLoading').style.display = 'none';
                isFirstLoad = false;

                setTimeout(async () => {
                    try {
                        const res2 = await fetch(URL_PRO, { cache: "default" });
                        if (res2.ok) {
                            const json2 = await res2.json();
                            allProProducts = Array.isArray(json2) ? json2 : (json2["mar_pro"] || []);
                        }
                    } catch (e) {}
                }, 500);

            } catch (e) {
                console.error(e);
                document.getElementById('initialLoading').style.display = 'block';
                document.getElementById('initialLoading').innerHTML = `<span style="color:red">数据加载失败</span>`;
            }
        }

        // ================= 加载更多逻辑 =================
        window.loadNextPage = function() {
            if (isLoading) return;

            const maxPage = Math.ceil(filteredBestsellers.length / PAGE_SIZE);
            if (currentPage < maxPage) {
                isLoading = true;
                const btn = document.getElementById('loadMoreBtn');
                btn.textContent = "加载中...";
                btn.classList.add('disabled');

                setTimeout(() => {
                    currentPage++;
                    renderBestsellers(currentPage);
                    
                    isLoading = false;
                    btn.classList.remove('disabled');
                }, 300);
            }
        }

        // ================= 筛选逻辑 (进入/退出) =================

        // 1. 进入核心词模式
        window.setCoreTermFilter = function(term) {
            // 【关键】记录当前位置和页数
            lastScrollPosition = window.scrollY;
            savedPageCount = currentPage;

            currentCoreTerm = term; 
            document.getElementById('active-term-text').textContent = term;
            document.getElementById('filter-status-bar').classList.add('show');
            
            applyFilters();
            renderProSection(term);
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // 2. 退出核心词模式 (返回全部)
        window.clearCoreTermFilter = function() {
            currentCoreTerm = ""; 
            document.getElementById('filter-status-bar').classList.remove('show');
            document.getElementById('pro-section').classList.remove('active');
            
            // 重新计算过滤 (保留FBA状态)
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['配送方式'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                return matchShipping; 
            });

            document.getElementById('product-container').innerHTML = '';
            
            // 【关键修改】一次性渲染之前看过的所有数据，不要分批延迟，否则高度不够滚不下去
            // 使用同步循环渲染，确保DOM瞬间存在
            const totalItemsToShow = savedPageCount * PAGE_SIZE;
            const itemsToRender = filteredBestsellers.slice(0, totalItemsToShow);
            
            renderItemsDirectly(itemsToRender);

            // 恢复页码
            currentPage = savedPageCount;

            // 【关键修改】DOM 渲染完后立即滚动
            requestAnimationFrame(() => {
                window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
            });
        }

        // 新增：专门用于“返回全部”时的快速渲染函数 (不分批，瞬间撑开高度)
        function renderItemsDirectly(list) {
            const container = document.getElementById('product-container');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            list.forEach(item => {
                const card = createProductCard(item);
                container.appendChild(card);
            });

            // 恢复按钮状态
            loadMoreBtn.style.display = 'block';
            const hasMore = list.length < filteredBestsellers.length;
            if (hasMore) {
                loadMoreBtn.textContent = '点击加载更多商品';
                loadMoreBtn.classList.remove('disabled');
            } else {
                loadMoreBtn.textContent = '已显示全部商品';
                loadMoreBtn.classList.add('disabled');
            }
        }

        window.scrollToProSection = function() {
            const section = document.getElementById('pro-section');
            if(section.classList.contains('active')) {
                const y = section.getBoundingClientRect().top + window.scrollY - 80;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }

        function applyFilters() {
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['配送方式'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                const term = item['核心搜索词中文'] || item['搜索词'] || "";
                const matchTerm = currentCoreTerm ? term === currentCoreTerm : true;
                return matchShipping && matchTerm;
            });
            currentPage = 1;
            document.getElementById('product-container').innerHTML = '';
            renderBestsellers(currentPage);
        }

        // ================= 渲染逻辑 =================
        function renderBestsellers(page) {
            const start = (page - 1) * PAGE_SIZE;
            const end = page * PAGE_SIZE;
            const list = filteredBestsellers.slice(start, end);
            
            const container = document.getElementById('product-container');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if (list.length === 0 && page === 1) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">暂无匹配商品</div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // 分批渲染防卡顿 (仅用于正常浏览，返回操作走上面的 renderItemsDirectly)
            const batchSize = 6;
            let currentIndex = 0;

            function renderBatch() {
                const batch = list.slice(currentIndex, currentIndex + batchSize);
                if (batch.length === 0) {
                    const hasMore = end < filteredBestsellers.length;
                    loadMoreBtn.style.display = 'block'; 
                    if (hasMore) {
                        loadMoreBtn.textContent = '点击加载更多商品';
                        loadMoreBtn.classList.remove('disabled');
                    } else {
                        loadMoreBtn.textContent = '已显示全部商品';
                        loadMoreBtn.classList.add('disabled');
                    }
                    isLoading = false;
                    return;
                }

                batch.forEach(item => {
                    const card = createProductCard(item);
                    container.appendChild(card);
                });

                currentIndex += batchSize;
                setTimeout(renderBatch, 5);
            }
            renderBatch();
        }

        // 提取创建卡片的逻辑，复用代码
        function createProductCard(item) {
            const title = item['商品名称'] || item.title || "未知";
            const img = optimizeImg(item['图片链接'] || item.first_image_url);
            const link = item['产品链接'] || item.url || "#";
            const term = item['核心搜索词中文'] || item['搜索词'] || "";
            const price = item['价格'] || item.price || "0.00";
            const date = item['上架时间'] || item.launch_date || "-";
            const ship = item.shipping_method || item['配送方式'] || "";
            const keyword = item['搜索关键词'] || item['search_keyword'] || "-";

            const termHtml = term ? 
                `<span class="clickable-term" onclick="setCoreTermFilter('${term}')" title="点击筛选">${term}</span>` : "无";

            const div = document.createElement('div');
            div.className = 'product-card';
            div.innerHTML = `
                <img class="product-img" 
                     src="${img || 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='}" 
                     loading="lazy" 
                     onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='; this.classList.add('error')"
                     onload="this.classList.add('loaded')">
                <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                
                <div class="product-meta">
                    <span style="background:#f0f0f0;padding:2px 6px;border-radius:4px">${ship}</span> 
                    <span class="price-tag">${price}</span>
                </div>

                <div class="product-meta-start"><span>核心词：</span>${termHtml}</div>
                <div class="product-meta-start"><span>关键词：</span>${keyword}</div>
                
                <div class="product-meta"><span>上架：${date}</span></div>
                <a class="product-link" href="${link}" target="_blank">查看亚马逊详情</a>
            `;
            return div;
        }

        function renderProSection(targetTerm) {
            const container = document.getElementById('pro-container');
            container.innerHTML = '';
            document.getElementById('pro-term-text').textContent = targetTerm;
            
            const proList = allProProducts.filter(item => (item['搜索词'] || "") === targetTerm);
            const section = document.getElementById('pro-section');
            const emptyTip = document.getElementById('pro-empty-tip');
            
            section.classList.add('active');
            if (proList.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';

            proList.forEach(item => {
                const title = item['商品名称'] || "未知新品";
                const img = optimizeImg(item['图片链接']);
                const link = item['产品链接'] || "#";
                const date = item['上架时间'] || "-";
                const term = item['搜索词'] || "";

                const div = document.createElement('div');
                div.className = 'product-card pro-card';
                div.innerHTML = `
                    <img class="product-img" 
                         src="${img || 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='}" 
                         loading="lazy" 
                         onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='; this.classList.add('error')"
                         onload="this.classList.add('loaded')">
                    <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                    <div class="product-meta" style="color:#d46b08;font-weight:bold">1688 新品</div>
                    <div class="product-meta-start">匹配词：${term}</div>
                    <div class="product-meta">上架：${date}</div>
                    <a class="product-link pro-link" href="${link}" target="_blank">查看 1688 详情</a>
                `;
                container.appendChild(div);
            });
        }

        function optimizeImg(url) {
            if (!url) return ""; 
            if (url.includes("amazon.com/images/")) {
                return url.replace(/_AC_SL\d+_/g, "_AC_SL200_")
                          .replace(/\.jpg/, ".jpg?quality=80");
            }
            if (url.includes("hohopick.top")) {
                return url + (url.includes("?") ? "&" : "?") + "w=200&q=80";
            }
            return url;
        }

        function initSidebar() {
            const btns = document.querySelectorAll('.sidebar-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentFilter === btn.dataset.filter) {
                        currentFilter = ""; btn.classList.remove('active');
                    } else {
                        currentFilter = btn.dataset.filter;
                        btns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }

        const popup = document.getElementById('titlePopup');
        window.showPopup = function(el, text) {
            popup.textContent = text; popup.style.display = 'block';
            const rect = el.getBoundingClientRect();
            popup.style.top = (rect.bottom + 5) + 'px'; popup.style.left = rect.left + 'px';
        }
        window.hidePopup = function() { popup.style.display = 'none'; }
    </script>
