const URL_BESTSELLERS = "https://img.hohopick.top/march_bestsellers.json";
const URL_PRO = "https://img.hohopick.top/mar_pro.json";
const PAGE_SIZE = 12;

let allBestsellers = [];
let allProProducts = [];
let filteredBestsellers = [];
let currentPage = 1;

let currentFilter = "";
let currentCoreTerm = "";
let lastScrollPosition = 0;
let savedPageCount = 1;

let isFirstLoad = true;
let isLoading = false;

window.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    initSidebar();
    initPopup();
    window.addEventListener('scroll', handleScroll); // 保留滚动监听
});

async function loadAllData() {
    if(isFirstLoad) document.getElementById('initialLoading').style.display = 'block';
    try {
        const [res1, res2] = await Promise.all([
            fetch(URL_BESTSELLERS, {cache: "no-cache"}),
            fetch(URL_PRO, {cache: "no-cache"})
        ]);
        if (!res1.ok) throw new Error("热销品数据加载失败");
        
        const json1 = await res1.json();
        allBestsellers = Array.isArray(json1) ? json1 : (json1["march_bestsellers"] || []);
        
        if (res2.ok) {
            const json2 = await res2.json();
            allProProducts = Array.isArray(json2) ? json2 : (json2["mar_pro"] || []);
        }

        filteredBestsellers = [...allBestsellers];
        renderBestsellers(1);
        document.getElementById('initialLoading').style.display = 'none';
        isFirstLoad = false;
    } catch (e) {
        console.error(e);
        document.getElementById('initialLoading').innerHTML = 
            `<span style="color:red">数据加载失败: ${e.message}</span><br><button onclick="location.reload()" style="margin-top:10px;padding:5px 10px;">重试</button>`;
    }
}

// ========== 修复1：兼容多浏览器的滚动触发条件 ==========
function handleScroll() {
    if (currentCoreTerm !== "" || isLoading) return; // 核心词筛选/加载中不触发

    // 兼容 document.documentElement 和 document.body 的 scrollTop
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
    const clientHeight = document.documentElement.clientHeight || window.innerHeight;

    // 距离底部 200px 触发，同时增加“页面高度不足时强制触发”逻辑
    const isNearBottom = scrollTop + clientHeight >= scrollHeight - 200;
    const isPageShort = scrollHeight <= clientHeight + 100; // 页面高度不足时也触发

    if (isNearBottom || isPageShort) {
        loadNextPage();
    }
}

// ========== 修复2：重构 loadNextPage，正确重置加载状态和提示 ==========
window.loadNextPage = function() {
    if (isLoading) return;

    const maxPage = Math.ceil(filteredBestsellers.length / PAGE_SIZE);
    if (currentPage < maxPage) {
        isLoading = true;
        
        const btn = document.getElementById('loadMoreBtn');
        const tip = document.getElementById('scrollLoadTip');

        // 显示加载提示
        if (currentCoreTerm) {
            btn.textContent = "加载中...";
            btn.classList.add('disabled');
        } else {
            tip.style.display = 'block';
            tip.textContent = "正在加载更多商品..."; // 明确提示文本
        }

        setTimeout(() => {
            currentPage++;
            renderBestsellers(currentPage);
            
            // 加载完成后重置状态（关键修复）
            isLoading = false;
            if (currentCoreTerm) {
                btn.classList.remove('disabled');
            } else {
                tip.style.display = 'none'; // 隐藏滚动加载提示
            }
        }, 300);
    } else {
        // 无更多数据时的提示
        const tip = document.getElementById('scrollLoadTip');
        const btn = document.getElementById('loadMoreBtn');
        if (currentCoreTerm) {
            btn.textContent = '已显示全部商品';
            btn.classList.add('disabled');
        } else {
            tip.style.display = 'block';
            tip.textContent = '没有更多商品了';
        }
        isLoading = false;
    }
}

window.setCoreTermFilter = function(term) {
    lastScrollPosition = window.scrollY;
    savedPageCount = currentPage;

    currentCoreTerm = term;
    document.getElementById('active-term-text').textContent = term;
    document.getElementById('filter-status-bar').classList.add('show');
    
    applyFilters();
    renderProSection(term);
    window.scrollTo({ top: 0, behavior: 'auto' });
}

window.clearCoreTermFilter = function() {
    currentCoreTerm = "";
    document.getElementById('filter-status-bar').classList.remove('show');
    document.getElementById('pro-section').classList.remove('active');
    
    filteredBestsellers = allBestsellers.filter(item => {
        const shipping = item.shipping_method || item['配送方式'];
        const matchShipping = currentFilter ? shipping === currentFilter : true;
        return matchShipping;
    });

    document.getElementById('product-container').innerHTML = '';
    currentPage = 1; // 修复：重置页码，避免残留
    for (let i = 1; i <= savedPageCount; i++) {
        renderBestsellers(i);
    }
    currentPage = savedPageCount;

    setTimeout(() => {
        window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
    }, 0);
}

window.scrollToProSection = function() {
    const section = document.getElementById('pro-section');
    if(section.classList.contains('active')) {
        const y = section.getBoundingClientRect().top + window.scrollY - 80;
        window.scrollTo({ top: y, behavior: 'smooth' });
    }
}

function applyFilters() {
    filteredBestsellers = allBestsellers.filter(item => {
        const shipping = item.shipping_method || item['配送方式'];
        const matchShipping = currentFilter ? shipping === currentFilter : true;
        const term = item['核心搜索词中文'] || item['搜索词'] || "";
        const matchTerm = currentCoreTerm ? term === currentCoreTerm : true;
        return matchShipping && matchTerm;
    });
    currentPage = 1;
    document.getElementById('product-container').innerHTML = '';
    renderBestsellers(currentPage);
}

// ========== 修复3：重构 renderBestsellers 中的提示逻辑 ==========
function renderBestsellers(page) {
    const start = (page - 1) * PAGE_SIZE;
    const end = page * PAGE_SIZE;
    const list = filteredBestsellers.slice(start, end);
    
    const container = document.getElementById('product-container');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const scrollTip = document.getElementById('scrollLoadTip');

    if (list.length === 0 && page === 1) {
        container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">暂无匹配商品</div>';
        loadMoreBtn.style.display = 'none';
        scrollTip.style.display = 'none';
        isLoading = false; // 兜底重置
        return;
    }

    list.forEach(item => {
        const title = item['商品名称'] || item.title || "未知";
        const img = optimizeImg(item['图片链接'] || item.first_image_url);
        const link = item['产品链接'] || item.url || "#";
        const term = item['核心搜索词中文'] || item['搜索词'] || "";
        const price = item['价格'] || item.price || "0.00";
        const date = item['上架时间'] || item.launch_date || "-";
        const ship = item.shipping_method || item['配送方式'] || "";
        const keyword = item['搜索关键词'] || item['search_keyword'] || "-";

        const termHtml = term ?
            `<span class="clickable-term" onclick="setCoreTermFilter('${term}')" title="点击筛选">${term}</span>` : "无";

        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <img class="product-img" src="${img}" loading="lazy" onerror="this.classList.add('error')">
            <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
            
            <div class="product-meta">
                <span style="background:#f0f0f0;padding:2px 6px;border-radius:4px">${ship}</span>
                <span class="price-tag">${price}</span>
            </div>

            <div class="product-meta-start"><span>核心词：</span>${termHtml}</div>
            <div class="product-meta-start"><span>关键词：</span>${keyword}</div>
            
            <div class="product-meta"><span>上架：${date}</span></div>
            <a class="product-link" href="${link}" target="_blank">查看亚马逊详情</a>
        `;
        container.appendChild(div);
    });

    // 修复4：正确的提示逻辑
    const hasMore = end < filteredBestsellers.length;
    if (currentCoreTerm) {
        // 核心词筛选模式：显示按钮
        scrollTip.style.display = 'none';
        loadMoreBtn.style.display = 'block';
        if (hasMore) {
            loadMoreBtn.textContent = '点击加载更多商品';
            loadMoreBtn.classList.remove('disabled');
        } else {
            loadMoreBtn.textContent = '已显示全部商品';
            loadMoreBtn.classList.add('disabled');
        }
    } else {
        // 滚动加载模式：显示提示
        loadMoreBtn.style.display = 'none';
        if (hasMore) {
            scrollTip.style.display = 'none'; // 有更多数据，隐藏提示（等待滚动触发）
        } else {
            scrollTip.style.display = 'block';
            scrollTip.textContent = '没有更多商品了'; // 无数据时显示提示
        }
    }
    isLoading = false; // 确保加载完成后重置状态
}

function renderProSection(targetTerm) {
    const container = document.getElementById('pro-container');
    container.innerHTML = '';
    document.getElementById('pro-term-text').textContent = targetTerm;
    
    const proList = allProProducts.filter(item => (item['搜索词'] || "") === targetTerm);
    const section = document.getElementById('pro-section');
    const emptyTip = document.getElementById('pro-empty-tip');
    
    section.classList.add('active');
    if (proList.length === 0) {
        emptyTip.style.display = 'block';
        return;
    }
    emptyTip.style.display = 'none';

    proList.forEach(item => {
        const title = item['商品名称'] || "未知新品";
        const img = optimizeImg(item['图片链接']);
        const link = item['产品链接'] || "#";
        const date = item['上架时间'] || "-";
        const term = item['搜索词'] || "";

        const div = document.createElement('div');
        div.className = 'product-card pro-card';
        div.innerHTML = `
            <img class="product-img" src="${img}" loading="lazy" onerror="this.classList.add('error')">
            <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
            <div class="product-meta" style="color:#d46b08;font-weight:bold">1688 新品</div>
            <div class="product-meta-start">匹配词：${term}</div>
            <div class="product-meta">上架：${date}</div>
            <a class="product-link pro-link" href="${link}" target="_blank">查看 1688 详情</a>
        `;
        container.appendChild(div);
    });
}

function optimizeImg(url) {
    if (!url) return "";
    if (url.includes("amazon.com/images/")) return url.replace(/_AC_SL\d+_/g, "_AC_SL300_");
    return url;
}

function initSidebar() {
    const btns = document.querySelectorAll('.sidebar-btn');
    btns.forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentFilter === btn.dataset.filter) {
                currentFilter = ""; btn.classList.remove('active');
            } else {
                currentFilter = btn.dataset.filter;
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            applyFilters();
        });
    });
}

const popup = document.getElementById('titlePopup');
window.showPopup = function(el, text) {
    popup.textContent = text; popup.style.display = 'block';
    const rect = el.getBoundingClientRect();
    popup.style.top = (rect.bottom + 5) + 'px'; popup.style.left = rect.left + 'px';
}
window.hidePopup = function() { popup.style.display = 'none'; }
