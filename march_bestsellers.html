<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CH-åŒæœŸ3æœˆçƒ­é”€å“</title>
    <style>
        /* ================= åŸºç¡€æ ·å¼ ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", sans-serif; }
        body { background: #f5f5f5; padding-bottom: 50px; }
        
        /* ================= å¯¼èˆªæ  (è¿˜åŸä¸‹æ‹‰èœå•æ ·å¼) ================= */
        .nav-header {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        .logo { font-size: 18px; font-weight: bold; color: #1677ff; text-decoration: none; }
        
        .nav-menu { display: flex; list-style: none; gap: 10px; align-items: center; }
        .nav-menu li { position: relative; } /* ä¸ºä¸‹æ‹‰èœå•å®šä½ */
        
        .nav-menu a {
            text-decoration: none; color: #333; font-size: 14px; 
            padding: 10px 15px; display: block; transition: color 0.2s;
        }
        .nav-menu a:hover, .nav-menu a.active { color: #1677ff; font-weight: bold; }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 120px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 1000;
            top: 100%;
            left: 0;
            border-radius: 4px;
        }
        .dropdown-content a {
            padding: 12px 16px;
            font-weight: normal;
            color: #333;
        }
        .dropdown-content a:hover {
            background-color: #f5f5f5;
            color: #1677ff;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* ================= æ ¸å¿ƒå¸ƒå±€ ================= */
        .header { text-align: center; margin: 30px 0; color: #333; }
        .main-content {
            display: flex; max-width: 1400px; margin: 0 auto; gap: 20px; align-items: flex-start; 
        }

        /* ä¾§è¾¹æ å›ºå®š */
        .sidebar {
            width: 80px; flex-shrink: 0; position: sticky; top: 80px; z-index: 10;
        }
        .sidebar-btn {
            display: block; width: 100%; padding: 12px 0; margin-bottom: 10px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; font-size: 13px; color: #666;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .sidebar-btn:hover, .sidebar-btn.active {
            background: #1677ff; color: white; border-color: #1677ff;
            box-shadow: 0 4px 10px rgba(22, 119, 255, 0.3);
        }

        .content-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        /* ================= ç­›é€‰çŠ¶æ€æ  ================= */
        .filter-status-bar {
            display: none; background: #e6f7ff; border: 1px solid #91caff;
            padding: 15px 20px; margin-bottom: 20px; border-radius: 8px;
            align-items: center; justify-content: space-between;
            color: #0050b3; font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 80, 179, 0.1);
        }
        .filter-status-bar.show { display: flex; animation: slideDown 0.3s ease-out; }
        .status-actions { display: flex; gap: 10px; }
        .btn-action {
            border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .btn-jump { background: #faad14; color: white; }
        .btn-clear { background: #1677ff; color: white; }
        
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ================= å•†å“ç½‘æ ¼ ================= */
        .container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .product-card {
            background: white; border-radius: 8px; padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
        
        .product-img {
            width: 100%; height: 220px; object-fit: cover; border-radius: 6px;
            margin-bottom: 10px; background: #f0f0f0; transition: opacity 0.3s;
        }
        .product-img.loaded { opacity: 1; }
        
        .product-name {
            font-size: 14px; color: #333; line-height: 1.4; margin-bottom: 8px;
            height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            font-weight: 500;
        }
        
        /* è¿™é‡Œçš„ space-between æ˜¯ä¸ºäº†ä»·æ ¼å’ŒFBAæ ‡ç­¾ä¸¤ç«¯å¯¹é½ */
        .product-meta { font-size: 12px; color: #666; margin-bottom: 4px; display: flex; justify-content: space-between; }
        
        /* æ–°å¢ï¼šä¸“é—¨ç”¨äºæ ¸å¿ƒè¯çš„æ ·å¼ï¼Œå¼ºåˆ¶é å·¦å¯¹é½ï¼Œè§£å†³è·ç¦»å¤ªè¿œçš„é—®é¢˜ */
        .product-meta-start {
            font-size: 12px; color: #666; margin-bottom: 4px; 
            display: flex; 
            justify-content: flex-start; /* é å·¦å¯¹é½ */
            gap: 5px; /* é—´è· */
            align-items: center;
        }

        .clickable-term {
            color: #1677ff; cursor: pointer; text-decoration: underline; font-weight: bold;
        }
        .clickable-term:hover { background-color: #f0f5ff; }
        .price-tag { color: #cf1322; font-weight: bold; font-size: 14px; }
        
        .product-link {
            display: block; text-align: center; margin-top: auto; padding: 8px;
            background: #f0f5ff; color: #1677ff; text-decoration: none;
            border-radius: 4px; font-size: 12px; font-weight: 500;
        }
        .product-link:hover { background: #1677ff; color: white; }

        /* ================= 1688 æ–°å“åŒº ================= */
        .pro-section {
            display: none; margin-top: 20px; border-top: 2px dashed #d9d9d9; padding-top: 30px;
            background: #fffbe6; padding: 20px; border-radius: 8px; border: 1px solid #ffe58f;
        }
        .pro-section.active { display: block; animation: fadeIn 0.5s; }
        .pro-header {
            display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 10px;
        }
        .pro-title { font-size: 20px; color: #d46b08; font-weight: bold; }
        .pro-badge { background: #d46b08; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .pro-card { border: 1px solid #ffe58f; }
        .pro-link { background: #fff7e6; color: #d46b08; }
        .pro-link:hover { background: #d46b08; color: white; }

        .loading, .load-more { text-align: center; color: #999; padding: 20px; font-size: 14px; }
        .title-popup {
            position: fixed; background: rgba(0,0,0,0.8); color: white;
            padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 1000;
            display: none; max-width: 300px; pointer-events: none;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- è¿˜åŸåçš„å¯¼èˆªæ  -->
    <header class="nav-header">
        <div class="nav-container">
            <a href="index.html" class="logo">CH-å•†å“æ¨è</a>
            <ul class="nav-menu">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="new_pro.html">æœ€å¼ºæ–°å“æ¨èï¼ˆæ½œåŠ›çˆ†æ¬¾ï¼‰</a></li>
                
                <!-- ä¸‹æ‹‰èœå•ç»“æ„ -->
                <li class="dropdown">
                    <a href="#" class="active">åŒæœŸçƒ­é”€å“ â–¼</a>
                    <div class="dropdown-content">
                        <a href="march_bestsellers.html">åŒæœŸ3æœˆ</a>
                        <!-- ä»¥åå¯ä»¥åŠ  åŒæœŸ4æœˆ ç­‰ -->
                    </div>
                </li>

                <li><a href="#">å…¶ä»–åˆ†ç±»1ï¼ˆå¯æ‰©å±•ï¼‰</a></li>
                <li><a href="#">å…¶ä»–åˆ†ç±»2ï¼ˆå¯æ‰©å±•ï¼‰</a></li>
            </ul>
        </div>
    </header>

    <h1 class="header">CH-åŒæœŸçƒ­é”€å“ï¼ˆåŒæœŸ3æœˆï¼‰</h1>
    <div class="loading" id="initialLoading">æ­£åœ¨åŠ è½½æ•°æ®...</div>

    <div class="main-content">
        <div class="sidebar">
            <button class="sidebar-btn" data-filter="FBA">FBA</button>
            <button class="sidebar-btn" data-filter="FBM">FBM</button>
            <button class="sidebar-btn" data-filter="è‡ªè¥">è‡ªè¥</button>
            <button class="sidebar-btn" data-filter="ç¼ºè´§">ç¼ºè´§</button>
        </div>

        <div class="content-area">
            <div id="filter-status-bar" class="filter-status-bar">
                <div>
                    ğŸ” æ ¸å¿ƒæœç´¢è¯ï¼š<b id="active-term-text" style="font-size: 16px; margin-right: 10px;"></b>
                    <span style="font-size: 12px; color: #666;">(å·²å±•ç¤ºç›¸å…³çƒ­é”€å“)</span>
                </div>
                <div class="status-actions">
                    <button class="btn-action btn-jump" onclick="scrollToProSection()">âš¡ æŸ¥çœ‹1688åŒç±»æ–°å“</button>
                    <button class="btn-action btn-clear" onclick="clearCoreTermFilter()">ğŸ”™ è¿”å›å…¨éƒ¨</button>
                </div>
            </div>

            <div class="container" id="product-container"></div>
            <div class="load-more" id="loadMoreTip" style="display: none;">åŠ è½½ä¸­...</div>

            <div id="pro-section" class="pro-section">
                <div class="pro-header">
                    <span class="pro-badge">1688</span>
                    <h2 class="pro-title">åŒç±»æ–°å“æ¨è</h2>
                    <span style="color:#888; font-size: 14px;">(åŒ¹é…æœç´¢è¯ï¼š<span id="pro-term-text"></span>)</span>
                </div>
                <div class="container" id="pro-container"></div>
                <div id="pro-empty-tip" style="text-align: center; color: #999; padding: 20px; display: none;">
                    æš‚æ— è¯¥æœç´¢è¯å¯¹åº”çš„ 1688 æ–°å“
                </div>
            </div>
        </div>
    </div>

    <div id="titlePopup" class="title-popup"></div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const URL_BESTSELLERS = "https://img.hohopick.top/march_bestsellers.json";
        const URL_PRO = "https://img.hohopick.top/mar_pro.json";
        const PAGE_SIZE = 12;

        // ================= å…¨å±€å˜é‡ =================
        let allBestsellers = [];
        let allProProducts = [];
        let filteredBestsellers = [];
        let currentPage = 1;
        
        let currentFilter = ""; 
        let currentCoreTerm = ""; 
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ï¼šè®°å½•æ»šåŠ¨ä½ç½®
        let lastScrollPosition = 0;

        let isFirstLoad = true;
        let isLoading = false;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            initSidebar();
            initScroll();
            initPopup();
        });

        async function loadAllData() {
            if(isFirstLoad) document.getElementById('initialLoading').style.display = 'block';
            try {
                const [res1, res2] = await Promise.all([
                    fetch(URL_BESTSELLERS, {cache: "no-cache"}),
                    fetch(URL_PRO, {cache: "no-cache"})
                ]);
                if (!res1.ok) throw new Error("çƒ­é”€å“æ•°æ®åŠ è½½å¤±è´¥");
                
                const json1 = await res1.json();
                allBestsellers = Array.isArray(json1) ? json1 : (json1["march_bestsellers"] || []);
                
                if (res2.ok) {
                    const json2 = await res2.json();
                    allProProducts = Array.isArray(json2) ? json2 : (json2["mar_pro"] || []);
                }

                filteredBestsellers = [...allBestsellers];
                renderBestsellers(1);
                document.getElementById('initialLoading').style.display = 'none';
                isFirstLoad = false;
            } catch (e) {
                console.error(e);
                document.getElementById('initialLoading').innerHTML = `<span style="color:red">æ•°æ®åŠ è½½å¤±è´¥: ${e.message}</span>`;
            }
        }

        // ================= ç­›é€‰é€»è¾‘ï¼ˆå«æ»šåŠ¨ä½ç½®è®°å¿†ï¼‰ =================

        window.setCoreTermFilter = function(term) {
            // ã€æ ¸å¿ƒæ­¥éª¤ 1ã€‘ï¼šä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            lastScrollPosition = window.scrollY;

            currentCoreTerm = term;
            document.getElementById('active-term-text').textContent = term;
            document.getElementById('filter-status-bar').classList.add('show');
            
            applyFilters();
            renderProSection(term);
            
            // ç­›é€‰åå›åˆ°é¡¶éƒ¨çœ‹è¯¦æƒ…
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        window.clearCoreTermFilter = function() {
            currentCoreTerm = "";
            document.getElementById('filter-status-bar').classList.remove('show');
            document.getElementById('pro-section').classList.remove('active');
            
            applyFilters();
            
            // ã€æ ¸å¿ƒæ­¥éª¤ 2ã€‘ï¼šæ¢å¤åˆ°ä¹‹å‰çš„ä½ç½®
            // ä½¿ç”¨ setTimeout ç¡®ä¿é¡µé¢æ¸²æŸ“å®Œåå†æ»šåŠ¨
            setTimeout(() => {
                window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
            }, 0);
        }

        window.scrollToProSection = function() {
            const section = document.getElementById('pro-section');
            if(section.classList.contains('active')) {
                const y = section.getBoundingClientRect().top + window.scrollY - 80;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }

        function applyFilters() {
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['é…é€æ–¹å¼'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                const term = item['æ ¸å¿ƒæœç´¢è¯ä¸­æ–‡'] || item['æœç´¢è¯'] || "";
                const matchTerm = currentCoreTerm ? term === currentCoreTerm : true;
                return matchShipping && matchTerm;
            });
            currentPage = 1;
            document.getElementById('product-container').innerHTML = '';
            renderBestsellers(currentPage);
        }

        function renderBestsellers(page) {
            const start = (page - 1) * PAGE_SIZE;
            const end = page * PAGE_SIZE;
            const list = filteredBestsellers.slice(start, end);
            const container = document.getElementById('product-container');
            const loadMore = document.getElementById('loadMoreTip');

            if (list.length === 0 && page === 1) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">æš‚æ— åŒ¹é…å•†å“</div>';
                loadMore.style.display = 'none';
                return;
            }

            list.forEach(item => {
                const title = item['å•†å“åç§°'] || item.title || "æœªçŸ¥";
                const img = optimizeImg(item['å›¾ç‰‡é“¾æ¥'] || item.first_image_url);
                const link = item['äº§å“é“¾æ¥'] || item.url || "#";
                const term = item['æ ¸å¿ƒæœç´¢è¯ä¸­æ–‡'] || item['æœç´¢è¯'] || "";
                const price = item['ä»·æ ¼'] || item.price || "0.00";
                const date = item['ä¸Šæ¶æ—¶é—´'] || item.launch_date || "-";
                const ship = item.shipping_method || item['é…é€æ–¹å¼'] || "";
                const keyword = item['æœç´¢å…³é”®è¯'] || item['search_keyword'] || "-";

                const termHtml = term ? 
                    `<span class="clickable-term" onclick="setCoreTermFilter('${term}')" title="ç‚¹å‡»ç­›é€‰">${term}</span>` : "æ— ";

                const div = document.createElement('div');
                div.className = 'product-card';
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šä½¿ç”¨ product-meta-start ç±»ï¼Œè®©æ ¸å¿ƒè¯ç´§æŒ¨ç€
                div.innerHTML = `
                    <img class="product-img" src="${img}" loading="lazy" onerror="this.classList.add('error')">
                    <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                    
                    <div class="product-meta">
                        <span style="background:#f0f0f0;padding:2px 6px;border-radius:4px">${ship}</span> 
                        <span class="price-tag">${price}</span>
                    </div>

                    <div class="product-meta-start"><span>æ ¸å¿ƒè¯ï¼š</span>${termHtml}</div>
                    <div class="product-meta-start"><span>å…³é”®è¯ï¼š</span>${keyword}</div>
                    
                    <div class="product-meta"><span>ä¸Šæ¶ï¼š${date}</span></div>
                    <a class="product-link" href="${link}" target="_blank">æŸ¥çœ‹äºšé©¬é€Šè¯¦æƒ…</a>
                `;
                container.appendChild(div);
            });

            loadMore.style.display = (end < filteredBestsellers.length) ? 'block' : 'none';
            loadMore.textContent = (end < filteredBestsellers.length) ? 'ä¸Šæ‹‰åŠ è½½æ›´å¤š...' : 'æ²¡æœ‰æ›´å¤šäº†';
            isLoading = false;
        }

        function renderProSection(targetTerm) {
            const container = document.getElementById('pro-container');
            container.innerHTML = '';
            document.getElementById('pro-term-text').textContent = targetTerm;
            
            const proList = allProProducts.filter(item => (item['æœç´¢è¯'] || "") === targetTerm);
            const section = document.getElementById('pro-section');
            const emptyTip = document.getElementById('pro-empty-tip');
            
            section.classList.add('active');
            if (proList.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';

            proList.forEach(item => {
                const title = item['å•†å“åç§°'] || "æœªçŸ¥æ–°å“";
                const img = optimizeImg(item['å›¾ç‰‡é“¾æ¥']);
                const link = item['äº§å“é“¾æ¥'] || "#";
                const date = item['ä¸Šæ¶æ—¶é—´'] || "-";
                const term = item['æœç´¢è¯'] || "";

                const div = document.createElement('div');
                div.className = 'product-card pro-card';
                div.innerHTML = `
                    <img class="product-img" src="${img}" loading="lazy" onerror="this.classList.add('error')">
                    <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                    <div class="product-meta" style="color:#d46b08;font-weight:bold">1688 æ–°å“</div>
                    <div class="product-meta-start">åŒ¹é…è¯ï¼š${term}</div>
                    <div class="product-meta">ä¸Šæ¶ï¼š${date}</div>
                    <a class="product-link pro-link" href="${link}" target="_blank">æŸ¥çœ‹ 1688 è¯¦æƒ…</a>
                `;
                container.appendChild(div);
            });
        }

        function optimizeImg(url) {
            if (!url) return ""; 
            if (url.includes("amazon.com/images/")) return url.replace(/_AC_SL\d+_/g, "_AC_SL300_");
            return url;
        }

        function initSidebar() {
            const btns = document.querySelectorAll('.sidebar-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentFilter === btn.dataset.filter) {
                        currentFilter = ""; btn.classList.remove('active');
                    } else {
                        currentFilter = btn.dataset.filter;
                        btns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }

        function initScroll() {
            let timer;
            window.addEventListener('scroll', () => {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => {
                    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                    if (scrollTop + clientHeight >= scrollHeight - 300) {
                        const maxPage = Math.ceil(filteredBestsellers.length / PAGE_SIZE);
                        if (currentPage < maxPage && !isLoading) {
                            isLoading = true;
                            currentPage++;
                            renderBestsellers(currentPage);
                        }
                    }
                }, 100);
            });
        }

        const popup = document.getElementById('titlePopup');
        window.showPopup = function(el, text) {
            popup.textContent = text; popup.style.display = 'block';
            const rect = el.getBoundingClientRect();
            popup.style.top = (rect.bottom + 5) + 'px'; popup.style.left = rect.left + 'px';
        }
        window.hidePopup = function() { popup.style.display = 'none'; }
    </script>
</body>
</html>
