<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CH-åŒæœŸ3æœˆçƒ­é”€å“</title>
    
    <!-- âœ… 1. å¼•å…¥å…¬å…±CSS (è§£å†³å¯¼èˆªæ æ ·å¼) -->
    <link rel="stylesheet" href="common.css">
    
    <style>
        /* ================= é¡µé¢ä¿®å¤æ ·å¼ ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", sans-serif; }
        
        body { 
            background: #f5f5f5; 
            /* âœ… ä¿®å¤1ï¼šé¡¶éƒ¨å¢åŠ å†…è¾¹è·ï¼Œé˜²æ­¢è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ */
            padding: 90px 20px 50px 20px; 
        }

        /* æ ¸å¿ƒå¸ƒå±€ */
        .header { text-align: center; margin-bottom: 40px; color: #333; }
        
        .main-content {
            display: flex; 
            max-width: 1400px; 
            margin: 0 auto; 
            /* âœ… ä¿®å¤2ï¼šå¢å¤§é—´è·ï¼Œè®©FBAæŒ‰é’®å¾€å·¦ï¼Œå•†å“å¾€å³å±…ä¸­ */
            gap: 60px; 
            align-items: flex-start; 
        }

        /* ä¾§è¾¹æ å›ºå®š */
        .sidebar {
            width: 90px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹ç‚¹ */
            flex-shrink: 0; 
            position: sticky; 
            /* è·ç¦»é¡¶éƒ¨çš„è·ç¦» = å¯¼èˆªæ é«˜åº¦(60) + é—´éš™(20) */
            top: 80px; 
            z-index: 10;
        }
        .sidebar-btn {
            display: block; width: 100%; padding: 12px 0; margin-bottom: 15px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; font-size: 14px; color: #666;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sidebar-btn:hover, .sidebar-btn.active {
            background: #1677ff; color: white; border-color: #1677ff;
            box-shadow: 0 4px 10px rgba(22, 119, 255, 0.3);
            transform: translateY(-2px);
        }

        .content-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        /* ç­›é€‰çŠ¶æ€æ  */
        .filter-status-bar {
            display: none; background: #e6f7ff; border: 1px solid #91caff;
            padding: 15px 20px; margin-bottom: 20px; border-radius: 8px;
            align-items: center; justify-content: space-between;
            color: #0050b3; font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 80, 179, 0.1);
        }
        .filter-status-bar.show { display: flex; animation: slideDown 0.3s ease-out; }
        .status-actions { display: flex; gap: 10px; }
        .btn-action {
            border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .btn-jump { background: #faad14; color: white; }
        .btn-clear { background: #1677ff; color: white; }
        
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* å•†å“ç½‘æ ¼ */
        .container {
            display: grid; 
            /* ä¿è¯å¡ç‰‡å®½åº¦é€‚ä¸­ */
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 25px; 
            margin-bottom: 30px;
        }
        .product-card {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
        
        .product-img {
            width: 100%; height: 220px; object-fit: cover; border-radius: 6px;
            margin-bottom: 10px; background: #f0f0f0; transition: opacity 0.3s;
        }
        .product-img.loaded { opacity: 1; }
        
        .product-name {
            font-size: 14px; color: #333; line-height: 1.4; margin-bottom: 8px;
            height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            font-weight: 500;
        }
        
        .product-meta { font-size: 12px; color: #666; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        
        .product-meta-start {
            font-size: 12px; color: #666; margin-bottom: 6px; 
            display: flex; justify-content: flex-start; gap: 5px; align-items: center;
        }

        .clickable-term {
            color: #1677ff; cursor: pointer; text-decoration: underline; font-weight: bold;
        }
        .clickable-term:hover { background-color: #f0f5ff; }
        .price-tag { color: #cf1322; font-weight: bold; font-size: 15px; }
        
        .product-link {
            display: block; text-align: center; margin-top: auto; padding: 10px;
            background: #f0f5ff; color: #1677ff; text-decoration: none;
            border-radius: 4px; font-size: 13px; font-weight: 500;
        }
        .product-link:hover { background: #1677ff; color: white; }

        /* 1688 æ–°å“åŒº */
        .pro-section {
            display: none; margin-top: 20px; border-top: 2px dashed #d9d9d9; padding-top: 30px;
            background: #fffbe6; padding: 20px; border-radius: 8px; border: 1px solid #ffe58f;
        }
        .pro-section.active { display: block; animation: fadeIn 0.5s; }
        .pro-header {
            display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 10px;
        }
        .pro-title { font-size: 20px; color: #d46b08; font-weight: bold; }
        .pro-badge { background: #d46b08; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .pro-card { border: 1px solid #ffe58f; }
        .pro-link { background: #fff7e6; color: #d46b08; }
        .pro-link:hover { background: #d46b08; color: white; }

        /* åŠ è½½æ§ä»¶ */
        .loading { text-align: center; color: #999; padding: 20px; font-size: 14px; }
        
        /* æ»šåŠ¨åŠ è½½æç¤º (å¹³æ—¶éšè—) */
        .scroll-load-tip {
            text-align: center; color: #999; padding: 20px; font-size: 14px;
            display: none; 
        }

        /* æŒ‰é’®åŠ è½½æç¤º */
        .load-more-btn {
            display: none; margin: 30px auto; padding: 12px 40px;
            background-color: #fff; border: 1px solid #d9d9d9; border-radius: 30px;
            color: #666; font-size: 14px; cursor: pointer; transition: all 0.3s;
            text-align: center; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .load-more-btn:hover { color: #1677ff; border-color: #1677ff; background-color: #f0f5ff; }
        .load-more-btn.disabled { background-color: transparent; border-color: transparent; box-shadow: none; color: #ccc; cursor: default; pointer-events: none; }

        .title-popup {
            position: fixed; background: rgba(0,0,0,0.8); color: white;
            padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 1000;
            display: none; max-width: 300px; pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- âœ… 2. å¯¼èˆªæ å ä½ç¬¦ -->
    <div id="nav-placeholder"></div>

    <h1 class="header">CH-åŒæœŸçƒ­é”€å“ï¼ˆåŒæœŸ3æœˆï¼‰</h1>
    <div class="loading" id="initialLoading">æ­£åœ¨åŠ è½½æ•°æ®...</div>

    <div class="main-content">
        <div class="sidebar">
            <button class="sidebar-btn" data-filter="FBA">FBA</button>
            <button class="sidebar-btn" data-filter="FBM">FBM</button>
            <button class="sidebar-btn" data-filter="è‡ªè¥">è‡ªè¥</button>
            <button class="sidebar-btn" data-filter="ç¼ºè´§">ç¼ºè´§</button>
        </div>

        <div class="content-area">
            <div id="filter-status-bar" class="filter-status-bar">
                <div>
                    ğŸ” æ ¸å¿ƒæœç´¢è¯ï¼š<b id="active-term-text" style="font-size: 16px; margin-right: 10px;"></b>
                    <span style="font-size: 12px; color: #666;">(å·²å±•ç¤ºç›¸å…³çƒ­é”€å“)</span>
                </div>
                <div class="status-actions">
                    <button class="btn-action btn-jump" onclick="scrollToProSection()">âš¡ æŸ¥çœ‹1688åŒç±»æ–°å“</button>
                    <button class="btn-action btn-clear" onclick="clearCoreTermFilter()">ğŸ”™ è¿”å›å…¨éƒ¨</button>
                </div>
            </div>

            <div class="container" id="product-container"></div>
            
            <!-- æ¨¡å¼ 1ï¼šæ— é™æ»šåŠ¨æç¤º (é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º) -->
            <div id="scrollLoadTip" class="scroll-load-tip">æ­£åœ¨åŠ è½½æ›´å¤šå•†å“...</div>

            <!-- æ¨¡å¼ 2ï¼šç‚¹å‡»åŠ è½½æŒ‰é’® -->
            <button id="loadMoreBtn" class="load-more-btn" onclick="loadNextPage()">
                ç‚¹å‡»åŠ è½½æ›´å¤šå•†å“
            </button>

            <div id="pro-section" class="pro-section">
                <div class="pro-header">
                    <span class="pro-badge">1688</span>
                    <h2 class="pro-title">åŒç±»æ–°å“æ¨è</h2>
                    <span style="color:#888; font-size: 14px;">(åŒ¹é…æœç´¢è¯ï¼š<span id="pro-term-text"></span>)</span>
                </div>
                <div class="container" id="pro-container"></div>
                <div id="pro-empty-tip" style="text-align: center; color: #999; padding: 20px; display: none;">
                    æš‚æ— è¯¥æœç´¢è¯å¯¹åº”çš„ 1688 æ–°å“
                </div>
            </div>
        </div>
    </div>

    <div id="titlePopup" class="title-popup"></div>

    <!-- âœ… 3. å¼•å…¥å…¬å…±å¯¼èˆªè„šæœ¬ -->
    <script src="common-nav.js"></script>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const URL_BESTSELLERS = "https://img.hohopick.top/march_bestsellers.json";
        const URL_PRO = "https://img.hohopick.top/mar_pro.json";
        const PAGE_SIZE = 12;

        // ================= å…¨å±€å˜é‡ =================
        let allBestsellers = [];
        let allProProducts = [];
        let filteredBestsellers = [];
        let currentPage = 1;
        
        let currentFilter = ""; 
        let currentCoreTerm = ""; 
        let lastScrollPosition = 0;
        let savedPageCount = 1;

        let isFirstLoad = true;
        let isLoading = false;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            initSidebar();
            initPopup();
            initScroll();
        });

        async function loadAllData() {
            if(isFirstLoad) document.getElementById('initialLoading').style.display = 'block';
            try {
                // å¹¶è¡ŒåŠ è½½ï¼Œæé«˜é€Ÿåº¦
                const [res1, res2] = await Promise.all([
                    fetch(URL_BESTSELLERS, {cache: "no-cache"}),
                    fetch(URL_PRO, {cache: "no-cache"})
                ]);
                
                if (!res1.ok) throw new Error("çƒ­é”€å“æ•°æ®åŠ è½½å¤±è´¥");
                
                const json1 = await res1.json();
                allBestsellers = Array.isArray(json1) ? json1 : (json1["march_bestsellers"] || []);
                
                if (res2.ok) {
                    const json2 = await res2.json();
                    allProProducts = Array.isArray(json2) ? json2 : (json2["mar_pro"] || []);
                }

                filteredBestsellers = [...allBestsellers];
                renderBestsellers(1);
                
                document.getElementById('initialLoading').style.display = 'none';
                isFirstLoad = false;
            } catch (e) {
                console.error(e);
                document.getElementById('initialLoading').innerHTML = 
                    `<span style="color:red">æ•°æ®åŠ è½½å¤±è´¥: ${e.message}</span><br><button onclick="location.reload()" style="margin-top:10px;padding:5px 10px;">é‡è¯•</button>`;
            }
        }

        // ================= åŠ è½½ä¸‹ä¸€é¡µé€»è¾‘ =================
        window.loadNextPage = function() {
            if (isLoading) return; 

            const maxPage = Math.ceil(filteredBestsellers.length / PAGE_SIZE);
            if (currentPage < maxPage) {
                isLoading = true;
                
                const btn = document.getElementById('loadMoreBtn');
                const tip = document.getElementById('scrollLoadTip');
                
                // åªæœ‰åœ¨æ ¸å¿ƒè¯æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºæŒ‰é’®æ–‡å­—å˜åŒ–
                if (currentCoreTerm) {
                    btn.textContent = "åŠ è½½ä¸­...";
                } else {
                    // ä¸»é¡µæ¨¡å¼æ˜¾ç¤ºåº•éƒ¨æç¤º
                    tip.style.display = 'block';
                }

                setTimeout(() => {
                    currentPage++;
                    renderBestsellers(currentPage);
                }, 100);
            }
        }

        // ================= æ»šåŠ¨ç›‘å¬ (åªåœ¨éç­›é€‰æ¨¡å¼ä¸‹ç”Ÿæ•ˆ) =================
        function initScroll() {
            let timer;
            window.addEventListener('scroll', () => {
                // å¦‚æœæ­£åœ¨ç­›é€‰æ ¸å¿ƒè¯ï¼Œç¦æ­¢æ— é™æ»šåŠ¨
                if (currentCoreTerm !== "") return; 

                if (timer) clearTimeout(timer);
                timer = setTimeout(() => {
                    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                    // è·ç¦»åº•éƒ¨ 300px è§¦å‘
                    if (scrollTop + clientHeight >= scrollHeight - 300) {
                        loadNextPage();
                    }
                }, 100);
            });
        }

        // ================= ç­›é€‰é€»è¾‘ =================
        window.setCoreTermFilter = function(term) {
            lastScrollPosition = window.scrollY;
            savedPageCount = currentPage;

            currentCoreTerm = term; 
            document.getElementById('active-term-text').textContent = term;
            document.getElementById('filter-status-bar').classList.add('show');
            
            applyFilters();
            renderProSection(term);
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        window.clearCoreTermFilter = function() {
            currentCoreTerm = ""; 
            document.getElementById('filter-status-bar').classList.remove('show');
            document.getElementById('pro-section').classList.remove('active');
            
            // é‡æ–°è®¡ç®—è¿‡æ»¤
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['é…é€æ–¹å¼'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                return matchShipping; 
            });

            // æ¢å¤ä¹‹å‰é¡µæ•°çš„æ•°æ®
            document.getElementById('product-container').innerHTML = '';
            for (let i = 1; i <= savedPageCount; i++) {
                renderBestsellers(i);
            }
            currentPage = savedPageCount;

            setTimeout(() => {
                window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
            }, 0);
        }

        window.scrollToProSection = function() {
            const section = document.getElementById('pro-section');
            if(section.classList.contains('active')) {
                // å‡å»å¯¼èˆªæ é«˜åº¦ï¼Œé˜²æ­¢é®æŒ¡æ ‡é¢˜
                const y = section.getBoundingClientRect().top + window.scrollY - 80;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }

        function applyFilters() {
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['é…é€æ–¹å¼'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                const term = item['æ ¸å¿ƒæœç´¢è¯ä¸­æ–‡'] || item['æœç´¢è¯'] || "";
                const matchTerm = currentCoreTerm ? term === currentCoreTerm : true;
                return matchShipping && matchTerm;
            });
            currentPage = 1;
            document.getElementById('product-container').innerHTML = '';
            renderBestsellers(currentPage);
        }

        // ================= æ¸²æŸ“é€»è¾‘ (å…³é”®ä¿®å¤) =================
        function renderBestsellers(page) {
            const start = (page - 1) * PAGE_SIZE;
            const end = page * PAGE_SIZE;
            const list = filteredBestsellers.slice(start, end);
            
            const container = document.getElementById('product-container');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const scrollTip = document.getElementById('scrollLoadTip');

            if (list.length === 0 && page === 1) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">æš‚æ— åŒ¹é…å•†å“</div>';
                loadMoreBtn.style.display = 'none';
                scrollTip.style.display = 'none';
                return;
            }

            list.forEach(item => {
                const title = item['å•†å“åç§°'] || item.title || "æœªçŸ¥";
                const img = optimizeImg(item['å›¾ç‰‡é“¾æ¥'] || item.first_image_url);
                const link = item['äº§å“é“¾æ¥'] || item.url || "#";
                const term = item['æ ¸å¿ƒæœç´¢è¯ä¸­æ–‡'] || item['æœç´¢è¯'] || "";
                const price = item['ä»·æ ¼'] || item.price || "0.00";
                const date = item['ä¸Šæ¶æ—¶é—´'] || item.launch_date || "-";
                const ship = item.shipping_method || item['é…é€æ–¹å¼'] || "";
                const keyword = item['æœç´¢å…³é”®è¯'] || item['search_keyword'] || "-";

                const termHtml = term ? 
                    `<span class="clickable-term" onclick="setCoreTermFilter('${term}')" title="ç‚¹å‡»ç­›é€‰">${term}</span>` : "æ— ";

                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `
                    <img class="product-img" src="${img}" loading="lazy" onerror="this.classList.add('error')">
                    <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                    
                    <div class="product-meta">
                        <span style="background:#f0f0f0;padding:2px 6px;border-radius:4px">${ship}</span> 
                        <span class="price-tag">${price}</span>
                    </div>

                    <div class="product-meta-start"><span>æ ¸å¿ƒè¯ï¼š</span>${termHtml}</div>
                    <div class="product-meta-start"><span>å…³é”®è¯ï¼š</span>${keyword}</div>
                    
                    <div class="product-meta"><span>ä¸Šæ¶ï¼š${date}</span></div>
                    <a class="product-link" href="${link}" target="_blank">æŸ¥çœ‹äºšé©¬é€Šè¯¦æƒ…</a>
                `;
                container.appendChild(div);
            });

            // âœ… å…³é”®ä¿®å¤ï¼šæ•°æ®åŠ è½½å®Œåï¼Œéšè—â€œåŠ è½½ä¸­â€æç¤º
            const hasMore = end < filteredBestsellers.length;

            if (currentCoreTerm) {
                // --- æ¨¡å¼ 2ï¼šç­›é€‰çŠ¶æ€ (æŒ‰é’®) ---
                scrollTip.style.display = 'none'; 
                loadMoreBtn.style.display = 'block'; 
                
                if (hasMore) {
                    loadMoreBtn.textContent = 'ç‚¹å‡»åŠ è½½æ›´å¤šå•†å“';
                    loadMoreBtn.classList.remove('disabled');
                } else {
                    loadMoreBtn.textContent = 'å·²æ˜¾ç¤ºå…¨éƒ¨å•†å“';
                    loadMoreBtn.classList.add('disabled');
                }
            } else {
                // --- æ¨¡å¼ 1ï¼šä¸»é¡µçŠ¶æ€ (æ»šåŠ¨) ---
                loadMoreBtn.style.display = 'none'; 
                
                if (hasMore) {
                    // è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œéšè—æç¤ºï¼Œç­‰å¾…æ»šåŠ¨è§¦å‘
                    scrollTip.style.display = 'none'; 
                } else {
                    // æ²¡æœ‰æ›´å¤šäº†
                    scrollTip.style.display = 'block';
                    scrollTip.textContent = 'æ²¡æœ‰æ›´å¤šå•†å“äº†';
                }
            }
            
            isLoading = false;
        }

        function renderProSection(targetTerm) {
            const container = document.getElementById('pro-container');
            container.innerHTML = '';
            document.getElementById('pro-term-text').textContent = targetTerm;
            
            const proList = allProProducts.filter(item => (item['æœç´¢è¯'] || "") === targetTerm);
            const section = document.getElementById('pro-section');
            const emptyTip = document.getElementById('pro-empty-tip');
            
            section.classList.add('active');
            if (proList.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';

            proList.forEach(item => {
                const title = item['å•†å“åç§°'] || "æœªçŸ¥æ–°å“";
                const img = optimizeImg(item['å›¾ç‰‡é“¾æ¥']);
                const link = item['äº§å“é“¾æ¥'] || "#";
                const date = item['ä¸Šæ¶æ—¶é—´'] || "-";
                const term = item['æœç´¢è¯'] || "";

                const div = document.createElement('div');
                div.className = 'product-card pro-card';
                div.innerHTML = `
                    <img class="product-img" src="${img}" loading="lazy" onerror="this.classList.add('error')">
                    <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                    <div class="product-meta" style="color:#d46b08;font-weight:bold">1688 æ–°å“</div>
                    <div class="product-meta-start">åŒ¹é…è¯ï¼š${term}</div>
                    <div class="product-meta">ä¸Šæ¶ï¼š${date}</div>
                    <a class="product-link pro-link" href="${link}" target="_blank">æŸ¥çœ‹ 1688 è¯¦æƒ…</a>
                `;
                container.appendChild(div);
            });
        }

        function optimizeImg(url) {
            if (!url) return ""; 
            if (url.includes("amazon.com/images/")) return url.replace(/_AC_SL\d+_/g, "_AC_SL300_");
            return url;
        }

        function initSidebar() {
            const btns = document.querySelectorAll('.sidebar-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentFilter === btn.dataset.filter) {
                        currentFilter = ""; btn.classList.remove('active');
                    } else {
                        currentFilter = btn.dataset.filter;
                        btns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }

        const popup = document.getElementById('titlePopup');
        window.showPopup = function(el, text) {
            popup.textContent = text; popup.style.display = 'block';
            const rect = el.getBoundingClientRect();
            popup.style.top = (rect.bottom + 5) + 'px'; popup.style.left = rect.left + 'px';
        }
        window.hidePopup = function() { popup.style.display = 'none'; }
    </script>
</body>
</html>
