<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CH-åŒæœŸ3æœˆçƒ­é”€å“</title>
    
    <link rel="stylesheet" href="common.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", sans-serif; }
        
        body { 
            background: #f5f5f5; 
            padding: 90px 20px 50px 20px; 
        }

        .header { text-align: center; margin-bottom: 40px; color: #333; }
        
        .main-content {
            display: flex; 
            max-width: 1400px; 
            margin: 0 auto; 
            gap: 40px; 
            align-items: flex-start; 
        }

        .sidebar {
            width: 70px; 
            flex-shrink: 0; 
            position: sticky; 
            top: 80px; 
            z-index: 10;
        }
        
        .sidebar-btn {
            display: block; width: 100%; 
            padding: 8px 0; 
            margin-bottom: 12px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; 
            font-size: 13px; 
            color: #666;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sidebar-btn:hover, .sidebar-btn.active {
            background: #1677ff; color: white; border-color: #1677ff;
            box-shadow: 0 4px 10px rgba(22, 119, 255, 0.3);
            transform: translateY(-2px);
        }

        .content-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        .filter-status-bar {
            display: none; background: #e6f7ff; border: 1px solid #91caff;
            padding: 15px 20px; margin-bottom: 20px; border-radius: 8px;
            align-items: center; justify-content: space-between;
            color: #0050b3; font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 80, 179, 0.1);
        }
        .filter-status-bar.show { display: flex; animation: slideDown 0.3s ease-out; }
        .status-actions { display: flex; gap: 10px; }
        .btn-action {
            border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .btn-jump { background: #faad14; color: white; }
        .btn-clear { background: #1677ff; color: white; }
        
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .container {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 25px; 
            margin-bottom: 30px;
        }
        .product-card {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
        
        .product-img {
            width: 100%; height: 220px; object-fit: cover; border-radius: 6px;
            margin-bottom: 10px; background: #f0f0f0; transition: opacity 0.3s;
            opacity: 0.8;
        }
        .product-img.loaded { opacity: 1; }
        .product-img.error { background: #f8f8f8; }
        
        .product-name {
            font-size: 14px; color: #333; line-height: 1.4; margin-bottom: 8px;
            height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            font-weight: 500;
        }
        
        .product-meta { font-size: 12px; color: #666; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        
        .product-meta-start {
            font-size: 12px; color: #666; margin-bottom: 6px; 
            display: flex; justify-content: flex-start; gap: 5px; align-items: center;
        }

        .clickable-term {
            color: #1677ff; cursor: pointer; text-decoration: underline; font-weight: bold;
        }
        .clickable-term:hover { background-color: #f0f5ff; }
        .price-tag { color: #cf1322; font-weight: bold; font-size: 15px; }
        
        .product-link {
            display: block; text-align: center; margin-top: auto; padding: 10px;
            background: #f0f5ff; color: #1677ff; text-decoration: none;
            border-radius: 4px; font-size: 13px; font-weight: 500;
        }
        .product-link:hover { background: #1677ff; color: white; }

        .pro-section {
            display: none; margin-top: 20px; border-top: 2px dashed #d9d9d9; padding-top: 30px;
            background: #fffbe6; padding: 20px; border-radius: 8px; border: 1px solid #ffe58f;
        }
        .pro-section.active { display: block; animation: fadeIn 0.5s; }
        .pro-header {
            display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 10px;
        }
        .pro-title { font-size: 20px; color: #d46b08; font-weight: bold; }
        .pro-badge { background: #d46b08; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .pro-card { border: 1px solid #ffe58f; }
        .pro-link { background: #fff7e6; color: #d46b08; }
        .pro-link:hover { background: #d46b08; color: white; }

        /* åŠ è½½åŠ¨ç”» */
        .loading { 
            text-align: center; color: #999; padding: 40px; font-size: 14px; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .loading::before {
            content: ""; width: 20px; height: 20px;
            border: 2px solid #1677ff; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ç»Ÿä¸€çš„åŠ è½½æŒ‰é’® */
        .load-more-btn {
            display: none; /* é»˜è®¤éšè— */
            margin: 30px auto; padding: 12px 40px;
            background-color: #fff; border: 1px solid #d9d9d9; border-radius: 30px;
            color: #666; font-size: 14px; cursor: pointer; transition: all 0.3s;
            text-align: center; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .load-more-btn:hover { color: #1677ff; border-color: #1677ff; background-color: #f0f5ff; }
        .load-more-btn.disabled { 
            background-color: transparent; border-color: transparent; 
            box-shadow: none; color: #ccc; cursor: default; pointer-events: none; 
        }

        .title-popup {
            position: fixed; background: rgba(0,0,0,0.8); color: white;
            padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 1000;
            display: none; max-width: 300px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="nav-placeholder"></div>

    <h1 class="header">CH-åŒæœŸçƒ­é”€å“ï¼ˆåŒæœŸ3æœˆï¼‰</h1>
    <div class="loading" id="initialLoading">æ­£åœ¨åŠ è½½æ•°æ®...</div>

    <div class="main-content">
        <div class="sidebar">
            <button class="sidebar-btn" data-filter="FBA">FBA</button>
            <button class="sidebar-btn" data-filter="FBM">FBM</button>
            <button class="sidebar-btn" data-filter="è‡ªè¥">è‡ªè¥</button>
            <button class="sidebar-btn" data-filter="ç¼ºè´§">ç¼ºè´§</button>
        </div>

        <div class="content-area">
            <div id="filter-status-bar" class="filter-status-bar">
                <div>
                    ğŸ” æ ¸å¿ƒæœç´¢è¯ï¼š<b id="active-term-text" style="font-size: 16px; margin-right: 10px;"></b>
                    <span style="font-size: 12px; color: #666;">(å·²å±•ç¤ºç›¸å…³çƒ­é”€å“)</span>
                </div>
                <div class="status-actions">
                    <button class="btn-action btn-jump" onclick="scrollToProSection()">âš¡ æŸ¥çœ‹1688åŒç±»æ–°å“</button>
                    <button class="btn-action btn-clear" onclick="clearCoreTermFilter()">ğŸ”™ è¿”å›å…¨éƒ¨</button>
                </div>
            </div>

            <div class="container" id="product-container"></div>
            
            <!-- ç»Ÿä¸€ä½¿ç”¨æŒ‰é’®åŠ è½½ -->
            <button id="loadMoreBtn" class="load-more-btn" onclick="loadNextPage()">
                ç‚¹å‡»åŠ è½½æ›´å¤šå•†å“
            </button>

            <div id="pro-section" class="pro-section">
                <div class="pro-header">
                    <span class="pro-badge">1688</span>
                    <h2 class="pro-title">åŒç±»æ–°å“æ¨è</h2>
                    <span style="color:#888; font-size: 14px;">(åŒ¹é…æœç´¢è¯ï¼š<span id="pro-term-text"></span>)</span>
                </div>
                <div class="container" id="pro-container"></div>
                <div id="pro-empty-tip" style="text-align: center; color: #999; padding: 20px; display: none;">
                    æš‚æ— è¯¥æœç´¢è¯å¯¹åº”çš„ 1688 æ–°å“
                </div>
            </div>
        </div>
    </div>

    <div id="titlePopup" class="title-popup"></div>

    <script src="common-nav.js"></script>

    <script>
        const URL_BESTSELLERS = "https://img.hohopick.top/march_bestsellers.json";
        const URL_PRO = "https://img.hohopick.top/mar_pro.json";
        const PAGE_SIZE = 12;

        let allBestsellers = [];
        let allProProducts = [];
        let filteredBestsellers = [];
        let currentPage = 1;
        
        let currentFilter = ""; 
        let currentCoreTerm = ""; 
        let lastScrollPosition = 0;
        let savedPageCount = 1;

        let isFirstLoad = true;
        let isLoading = false;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            initSidebar();
            initPopup();
        });

        // ========== æ ¸å¿ƒä¼˜åŒ–ï¼šåˆ†æ­¥åŠ è½½ï¼ˆå…³é”®è·¯å¾„ä¼˜å…ˆï¼‰ ==========
        async function loadAllData() {
            if(isFirstLoad) document.getElementById('initialLoading').style.display = 'flex';
            try {
                // 1. ã€ä¼˜å…ˆã€‘åªåŠ è½½æ ¸å¿ƒçƒ­é”€å“æ•°æ® (march_bestsellers.json)
                const res1 = await fetch(URL_BESTSELLERS, {
                    cache: "default" 
                });
                if (!res1.ok) throw new Error("çƒ­é”€å“æ•°æ®åŠ è½½å¤±è´¥");
                
                const json1 = await res1.json();
                allBestsellers = Array.isArray(json1) ? json1 : (json1["march_bestsellers"] || []);
                filteredBestsellers = [...allBestsellers];
                
                // 2. ç«‹å³æ¸²æŸ“é¡µé¢ï¼Œè®©ç”¨æˆ·ä¸ç”¨ç­‰
                renderBestsellers(1);
                document.getElementById('initialLoading').style.display = 'none';
                isFirstLoad = false;

                // 3. ã€å»¶è¿Ÿã€‘æ‚„æ‚„åŠ è½½ 1688 æ•°æ® (mar_pro.json)
                // å»¶è¿Ÿ 500msï¼Œç­‰ä¸»é¡µé¢æ¸²æŸ“å®Œå†è¯·æ±‚ï¼Œä¸å ç”¨åˆå§‹å¸¦å®½
                setTimeout(async () => {
                    try {
                        const res2 = await fetch(URL_PRO, { cache: "default" });
                        if (res2.ok) {
                            const json2 = await res2.json();
                            allProProducts = Array.isArray(json2) ? json2 : (json2["mar_pro"] || []);
                            console.log("1688æ•°æ®åå°åŠ è½½å®Œæˆ");
                        }
                    } catch (e) {
                        console.warn("1688æ•°æ®åŠ è½½å¤±è´¥(éé˜»å¡):", e);
                    }
                }, 500);

            } catch (e) {
                console.error(e);
                document.getElementById('initialLoading').style.display = 'block';
                document.getElementById('initialLoading').innerHTML = 
                    `<span style="color:red">æ•°æ®åŠ è½½å¤±è´¥: ${e.message}</span><br><button onclick="location.reload()" style="margin-top:10px;padding:5px 10px;">é‡è¯•</button>`;
            }
        }

        // ========== ç»Ÿä¸€ä½¿ç”¨æŒ‰é’®åŠ è½½ ==========
        window.loadNextPage = function() {
            if (isLoading) return;

            const maxPage = Math.ceil(filteredBestsellers.length / PAGE_SIZE);
            if (currentPage < maxPage) {
                isLoading = true;
                const btn = document.getElementById('loadMoreBtn');
                btn.textContent = "åŠ è½½ä¸­...";
                btn.classList.add('disabled');

                setTimeout(() => {
                    currentPage++;
                    renderBestsellers(currentPage);
                    
                    isLoading = false;
                    btn.classList.remove('disabled');
                }, 300);
            }
        }

        // ========== ç­›é€‰é€»è¾‘ ==========
        window.setCoreTermFilter = function(term) {
            lastScrollPosition = window.scrollY;
            savedPageCount = currentPage;

            currentCoreTerm = term; 
            document.getElementById('active-term-text').textContent = term;
            document.getElementById('filter-status-bar').classList.add('show');
            
            applyFilters();
            renderProSection(term);
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        window.clearCoreTermFilter = function() {
            currentCoreTerm = ""; 
            document.getElementById('filter-status-bar').classList.remove('show');
            document.getElementById('pro-section').classList.remove('active');
            
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['é…é€æ–¹å¼'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                return matchShipping; 
            });

            document.getElementById('product-container').innerHTML = '';
            currentPage = 1; 
            // å¦‚æœä½ æƒ³è¿”å›æ—¶åªæ˜¾ç¤ºç¬¬ä¸€é¡µï¼Œç”¨ currentPage = 1
            // å¦‚æœä½ æƒ³æ¢å¤ä¹‹å‰çœ‹çš„é¡µæ•°ï¼Œç”¨ä¸‹é¢çš„å¾ªç¯ï¼š
            for (let i = 1; i <= savedPageCount; i++) {
                renderBestsellers(i);
            }
            currentPage = savedPageCount;

            setTimeout(() => {
                window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
            }, 0);
        }

        window.scrollToProSection = function() {
            const section = document.getElementById('pro-section');
            if(section.classList.contains('active')) {
                const y = section.getBoundingClientRect().top + window.scrollY - 80;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }

        function applyFilters() {
            filteredBestsellers = allBestsellers.filter(item => {
                const shipping = item.shipping_method || item['é…é€æ–¹å¼'];
                const matchShipping = currentFilter ? shipping === currentFilter : true;
                const term = item['æ ¸å¿ƒæœç´¢è¯ä¸­æ–‡'] || item['æœç´¢è¯'] || "";
                const matchTerm = currentCoreTerm ? term === currentCoreTerm : true;
                return matchShipping && matchTerm;
            });
            currentPage = 1;
            document.getElementById('product-container').innerHTML = '';
            renderBestsellers(currentPage);
        }

        // ========== æ¸²æŸ“é€»è¾‘ (ç»Ÿä¸€å¤„ç†æŒ‰é’®æ˜¾ç¤º) ==========
        function renderBestsellers(page) {
            const start = (page - 1) * PAGE_SIZE;
            const end = page * PAGE_SIZE;
            const list = filteredBestsellers.slice(start, end);
            
            const container = document.getElementById('product-container');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if (list.length === 0 && page === 1) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">æš‚æ— åŒ¹é…å•†å“</div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // åˆ†æ‰¹æ¸²æŸ“é˜²å¡é¡¿
            const batchSize = 6;
            let currentIndex = 0;

            function renderBatch() {
                const batch = list.slice(currentIndex, currentIndex + batchSize);
                if (batch.length === 0) {
                    // æ¸²æŸ“å®Œæˆï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
                    const hasMore = end < filteredBestsellers.length;
                    loadMoreBtn.style.display = 'block'; // å§‹ç»ˆæ˜¾ç¤ºæŒ‰é’®
                    
                    if (hasMore) {
                        loadMoreBtn.textContent = 'ç‚¹å‡»åŠ è½½æ›´å¤šå•†å“';
                        loadMoreBtn.classList.remove('disabled');
                    } else {
                        loadMoreBtn.textContent = 'å·²æ˜¾ç¤ºå…¨éƒ¨å•†å“';
                        loadMoreBtn.classList.add('disabled');
                    }
                    isLoading = false;
                    return;
                }

                batch.forEach(item => {
                    const title = item['å•†å“åç§°'] || item.title || "æœªçŸ¥";
                    const img = optimizeImg(item['å›¾ç‰‡é“¾æ¥'] || item.first_image_url);
                    const link = item['äº§å“é“¾æ¥'] || item.url || "#";
                    const term = item['æ ¸å¿ƒæœç´¢è¯ä¸­æ–‡'] || item['æœç´¢è¯'] || "";
                    const price = item['ä»·æ ¼'] || item.price || "0.00";
                    const date = item['ä¸Šæ¶æ—¶é—´'] || item.launch_date || "-";
                    const ship = item.shipping_method || item['é…é€æ–¹å¼'] || "";
                    const keyword = item['æœç´¢å…³é”®è¯'] || item['search_keyword'] || "-";

                    const termHtml = term ? 
                        `<span class="clickable-term" onclick="setCoreTermFilter('${term}')" title="ç‚¹å‡»ç­›é€‰">${term}</span>` : "æ— ";

                    const div = document.createElement('div');
                    div.className = 'product-card';
                    div.innerHTML = `
                        <img class="product-img" 
                             src="${img || 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='}" 
                             loading="lazy" 
                             onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='; this.classList.add('error')"
                             onload="this.classList.add('loaded')">
                        <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                        
                        <div class="product-meta">
                            <span style="background:#f0f0f0;padding:2px 6px;border-radius:4px">${ship}</span> 
                            <span class="price-tag">${price}</span>
                        </div>

                        <div class="product-meta-start"><span>æ ¸å¿ƒè¯ï¼š</span>${termHtml}</div>
                        <div class="product-meta-start"><span>å…³é”®è¯ï¼š</span>${keyword}</div>
                        
                        <div class="product-meta"><span>ä¸Šæ¶ï¼š${date}</span></div>
                        <a class="product-link" href="${link}" target="_blank">æŸ¥çœ‹äºšé©¬é€Šè¯¦æƒ…</a>
                    `;
                    container.appendChild(div);
                });

                currentIndex += batchSize;
                setTimeout(renderBatch, 5);
            }

            renderBatch();
        }

        function renderProSection(targetTerm) {
            const container = document.getElementById('pro-container');
            container.innerHTML = '';
            document.getElementById('pro-term-text').textContent = targetTerm;
            
            const proList = allProProducts.filter(item => (item['æœç´¢è¯'] || "") === targetTerm);
            const section = document.getElementById('pro-section');
            const emptyTip = document.getElementById('pro-empty-tip');
            
            section.classList.add('active');
            if (proList.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';

            proList.forEach(item => {
                const title = item['å•†å“åç§°'] || "æœªçŸ¥æ–°å“";
                const img = optimizeImg(item['å›¾ç‰‡é“¾æ¥']);
                const link = item['äº§å“é“¾æ¥'] || "#";
                const date = item['ä¸Šæ¶æ—¶é—´'] || "-";
                const term = item['æœç´¢è¯'] || "";

                const div = document.createElement('div');
                div.className = 'product-card pro-card';
                div.innerHTML = `
                    <img class="product-img" 
                         src="${img || 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='}" 
                         loading="lazy" 
                         onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='; this.classList.add('error')"
                         onload="this.classList.add('loaded')">
                    <div class="product-name" onmouseover="showPopup(this, '${title}')" onmouseout="hidePopup()">${title}</div>
                    <div class="product-meta" style="color:#d46b08;font-weight:bold">1688 æ–°å“</div>
                    <div class="product-meta-start">åŒ¹é…è¯ï¼š${term}</div>
                    <div class="product-meta">ä¸Šæ¶ï¼š${date}</div>
                    <a class="product-link pro-link" href="${link}" target="_blank">æŸ¥çœ‹ 1688 è¯¦æƒ…</a>
                `;
                container.appendChild(div);
            });
        }

        function optimizeImg(url) {
            if (!url) return ""; 
            if (url.includes("amazon.com/images/")) {
                return url.replace(/_AC_SL\d+_/g, "_AC_SL200_")
                          .replace(/\.jpg/, ".jpg?quality=80");
            }
            if (url.includes("hohopick.top")) {
                return url + (url.includes("?") ? "&" : "?") + "w=200&q=80";
            }
            return url;
        }

        function initSidebar() {
            const btns = document.querySelectorAll('.sidebar-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentFilter === btn.dataset.filter) {
                        currentFilter = ""; btn.classList.remove('active');
                    } else {
                        currentFilter = btn.dataset.filter;
                        btns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }

        const popup = document.getElementById('titlePopup');
        window.showPopup = function(el, text) {
            popup.textContent = text; popup.style.display = 'block';
            const rect = el.getBoundingClientRect();
            popup.style.top = (rect.bottom + 5) + 'px'; popup.style.left = rect.left + 'px';
        }
        window.hidePopup = function() { popup.style.display = 'none'; }
    </script>
</body>
</html>
